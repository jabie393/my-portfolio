name: ğŸš€ Laravel + Vite Auto Deploy (Staging & Production)

on:
  push:
    branches:
      - main
      - staging

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      PROJECT_NAME: "Laravel + Vite"
      DEPLOY_PATH_PROD: "/www/wwwroot/fahd.my.id"
      DEPLOY_PATH_STAGING: "/www/wwwroot/staging.fahd.my.id"
      BACKUP_PATH: "/www/wwwroot/backups"

    steps:
      # 1ï¸ Checkout kode dari GitHub
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸ Setup Node.js untuk Vite build
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3ï¸ Install & Build Vite
      - name: Build Frontend (Vite)
        run: |
          npm ci
          npm run build

      # 4ï¸ Setup PHP untuk Laravel build
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          extensions: mbstring, bcmath, intl, zip, gd, pdo_mysql
          coverage: none

      # 5ï¸ Install Composer dependencies
      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

      # 6ï¸ Tentukan target environment berdasarkan branch
      - name: Set environment path
        id: set-env
        run: |
          echo "env_label=fahd.my.id" >> $GITHUB_OUTPUT
          echo "commit_message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT

      # 7ï¸ Kirim Telegram Notif saat deploy dimulai
      - name: Telegram Notification (Start)
        run: |
          MSG="ğŸš€ *Deploy Dimulai!*%0A
          ğŸŒ Website: [*${{ steps.set-env.outputs.env_label }}*](https://${{ steps.set-env.outputs.env_label }})%0A
          ğŸ•’ $(TZ='Asia/Jakarta' date '+%d %b %Y, %H:%M:%S') WIB%0A
          ğŸ‘¤ Oleh: *${{ github.actor }}*%0A
          ğŸ’» Repository: *${{ github.repository }}*%0A
          ğŸ§© Branch: *${{ github.ref_name }}*%0A
          â³ Mohon tunggu..."
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d parse_mode="Markdown" \
            -d text="$MSG"

      # 8ï¸ Disable host key checking biar SSH gak error
      - name: Disable host key checking
        run: |
          mkdir -p ~/.ssh
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
          echo "UserKnownHostsFile=/dev/null" >> ~/.ssh/config

      # 9ï¸ Backup versi sebelumnya sebelum upload
      - name: Backup existing deployment
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ubuntu
          key: ${{ secrets.SERVER_SSH_KEY }}
          use_insecure_cipher: true
          script: |
            sudo -u www mkdir -p /www/wwwroot/backups
            cd /www/wwwroot/fahd.my.id || exit 0
            sudo -u www tar -czf /www/wwwroot/backups/backup_$(date +'%Y%m%d_%H%M%S').tar.gz . || echo "Backup skipped"

      # 10ï¸ Upload file ke server via rsync
      - name: Upload Files via rsync (Exclude certain files)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          use_insecure_cipher: true
          script: |
            echo "Syncing files via rsync..."
            rsync -avz --delete \
              --exclude '.env' \
              --exclude '.user.ini' \
              --exclude 'node_modules/' \
              --exclude 'storage/' \
              --exclude 'tests/' \
              --exclude '.git/' \
              --exclude '.github/' \
              --exclude 'public/projects/' \
              -e "ssh -o StrictHostKeyChecking=no" \
              ./ ${{ steps.set-env.outputs.target_path }}


      # 11ï¸ Jalankan artisan commands di server
      - name: Run Laravel Commands
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          use_insecure_cipher: true
          script: |
            cd ${{ steps.set-env.outputs.target_path }}
            php artisan down || true
            php artisan migrate --force
            php artisan optimize:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan up

      # 12ï¸ Telegram Notif jika sukses
      - name: Telegram Notification (Success)
        if: success()
        run: |
          MSG="âœ… *Deploy Berhasil!*%0A
          ğŸŒ Website: [*${{ steps.set-env.outputs.env_label }}*](https://${{ steps.set-env.outputs.env_label }})%0A
          ğŸ•’ $(TZ='Asia/Jakarta' date '+%d %b %Y, %H:%M:%S') WIB%0A
          ğŸ‘¤ Commit by: *${{ github.actor }}*%0A
          ğŸ§© Branch: *${{ github.ref_name }}*%0A
          ğŸ’» Repository: *${{ github.repository }}*%0A
          ğŸ‰ Berhasil di-*deploy* tanpa error!%0A
          ğŸ’¬ Pesan Commit: _${{ steps.set-env.outputs.commit_message }}_"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d parse_mode="Markdown" \
            -d text="$MSG"

      # 13ï¸ Rollback otomatis jika gagal deploy
      - name: Rollback if failed
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          use_insecure_cipher: true
          script: |
            cd ${{ env.BACKUP_PATH }}
            LATEST_BACKUP=$(ls -t backup_*.tar.gz | head -n 1)
            if [ -n "$LATEST_BACKUP" ]; then
              echo "ğŸ” Rolling back from backup: $LATEST_BACKUP"
              tar -xzf $LATEST_BACKUP -C ${{ steps.set-env.outputs.target_path }}
            fi

      # 14ï¸ Telegram Notif jika gagal
      - name: Telegram Notification (Failed)
        if: failure()
        run: |
          MSG="âŒ *Deploy Gagal!*%0A
          ğŸŒ Website: [*${{ steps.set-env.outputs.env_label }}*](https://${{ steps.set-env.outputs.env_label }})%0A
          ğŸ•’ $(TZ='Asia/Jakarta' date '+%d %b %Y, %H:%M:%S') WIB%0A
          ğŸ‘¤ Commit by: *${{ github.actor }}*%0A
          ğŸ§© Branch: *${{ github.ref_name }}*%0A
          ğŸ’» Repository: *${{ github.repository }}*%0A
          âš™ï¸ Deploy otomatis akan *rollback* ke versi terakhir.%0A
          ğŸ” Cek log GitHub Actions untuk detail error.%0A
          ğŸ’¬ Pesan Commit: _${{ steps.set-env.outputs.commit_message }}_"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d parse_mode="Markdown" \
            -d text="$MSG"
